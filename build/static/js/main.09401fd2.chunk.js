(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{73:function(e,t,n){e.exports=n(87)},84:function(e,t,n){},87:function(e,t,n){"use strict";n.r(t);var r,a=n(25),o=n.n(a),c=n(39),u=n(9),i=n(0),s=n(10),l=n(86),f=n(126),d=n(125),p="978388352537-fnn94mu0emjd6tdme0tokctt80iludg7.apps.googleusercontent.com",m="AIzaSyCNKv31Uepktj0jpyZ7xZy_NofctPYxH9M",g=["https://sheets.googleapis.com/$discovery/rest?version=v4","https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],h="https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.readonly",v=["WD11CD","WD11CDO","WD11NM","WD11NMW","Ward Code","Ward Name","LA Name","Region","Rurality","Constituency","Constituency Code","GE 2017"],w="_\xacNORMALISED\xac",b=new RegExp(w),O="_\xacRANKING\xac",k=new RegExp(O),y="Ward GeoJSON LatLng.json",j="Ward stats 2",E="API!A1:AD8571",S=n(112),C=n(134),W=n(8),N=n(116),x=Object(S.a)(function(e){return Object(C.a)({button:{marginTop:e.spacing(3)}})}),D=function(e){var t=e.apiKey,n=e.clientId,r=e.discoveryDocs,a=e.scope,o=Object(u.a)(e.signedInState,2),c=o[0],s=o[1],l=Object(W.a)(),f=x(l),d=i.useRef(null),p=i.useCallback(function(){d.current?d.current.auth2.getAuthInstance().signIn():alert("Google API not loaded")},[d]),m=i.useCallback(function(){d.current?d.current.auth2.getAuthInstance().signOut():alert("Google API not loaded")},[d]);return i.useEffect(function(){gapi.load("client:auth2",function(){gapi.client.init({apiKey:t,discoveryDocs:r,clientId:n,scope:a}).then(function(){d.current=gapi,gapi.auth2.getAuthInstance().isSignedIn.listen(s),s(gapi.auth2.getAuthInstance().isSignedIn.get())}).catch(function(e){return console.error(e)})})},[]),c?i.createElement(N.a,{className:f.button,variant:"contained",onClick:m},"Sign Out"):i.createElement(N.a,{className:f.button,variant:"contained",color:"primary",onClick:p},"Sign In")},R=n(42),I=n(62),M=n(54),A=function(){function e(t){Object(I.a)(this,e),this.value=void 0,this.value=t}return Object(M.a)(e,null,[{key:"preload",value:function(){return new e({status:"preload"})}},{key:"loading",value:function(){return new e({status:"loading"})}},{key:"error",value:function(t){return new e({status:"error",error:t})}},{key:"loaded",value:function(t){return new e({status:"loaded",data:t})}}]),Object(M.a)(e,[{key:"data",value:function(){return"loaded"===this.value.status?this.value.data:null}},{key:"error",value:function(){return"error"===this.value.status?this.value.error:null}},{key:"isLoading",value:function(){return"loading"===this.value.status}},{key:"isPreload",value:function(){return"preload"===this.value.status}},{key:"load",value:function(){return"preload"===this.value.status?e.loading():(console.error("Cannot load an ApiResponse in the ".concat(this.value.status," state.")),this)}},{key:"resolve",value:function(t){return"loading"===this.value.status?e.loaded(t):(console.error("Cannot resolve an ApiResponse in the ".concat(this.value.status," state.")),this)}},{key:"fail",value:function(t){return"loading"===this.value.status?e.error(t):(console.error("Cannot fail an ApiResponse in the ".concat(this.value.status," state.")),this)}},{key:"map",value:function(t){return"loaded"===this.value.status?e.loaded(t(this.value.data)):new e(this.value)}}]),e}();function P(e,t,n,r){var a=i.useState({}),o=Object(u.a)(a,2),c=o[0],s=o[1],l=i.useState(!1),f=Object(u.a)(l,2),d=f[0],p=f[1],m=i.useRef(),g=i.useRef();return i.useEffect(function(){return g.current=window.setTimeout(function(){window.clearInterval(m.current),d&&(s({}),p(!1))},r),function(){return window.clearTimeout(g.current)}},[d,r]),i.useEffect(function(){return p(!0),m.current=window.setTimeout(function(){p(!1),s({})},n),function(){return window.clearTimeout(m.current)}},[].concat(Object(R.a)(t),[n])),i.useEffect(function(){p(!1)},[c]),i.useMemo(function(){return e()},[c])}window.ApiResponse=A,function(e){e[e.Value=0]="Value",e[e.Normalised=1]="Normalised",e[e.Rank=2]="Rank"}(r||(r={}));var T=n(32),B=n(26);function J(e){var t=Object.keys(e[0]).filter(function(e){return!v.includes(e)});!function(e,t){var n=e.length-1;t.forEach(function(t){e.sort(function(e,n){return e[t]-n[t]}).forEach(function(e,r){e["".concat(t).concat(O)]=r/n})})}(e,t);var n=function(e,t){var n=e.reduce(function(e,n){return t.map(function(t,r){return{max:Math.max(e[r].max,n[t]),min:Math.min(e[r].min,n[t])}})},t.map(function(e){return{max:-1/0,min:1/0}}));return t.map(function(e,t){return{min:n[t].min,range:n[t].max-n[t].min}})}(e,t);return e.map(function(e){return Object(B.a)({},e,t.reduce(function(t,r,a){return Object(B.a)({},t,Object(T.a)({},"".concat(r).concat(w),function(e,t,n){var r=n.min,a=n.range;return(e[t]-r)*a}(e,r,n[a])))},{}))})}function L(e){var t=e[0];return e.slice(1).map(function(e){return t.reduce(function(t,n,r){return t[n]=e[r],t},{})})}function z(e,t){return Object.keys(e).reduce(function(n,a){var o=e[a],c=o.weight,u=o.type,i=u===r.Normalised?"".concat(a).concat(w):u===r.Rank?"".concat(a).concat(O):a;return n+c*(t[i]||0)},0)}var F=n(131),G=n(139),K=n(132),V=function(e){var t=e.weightings,n=e.minScore,r=e.scoreRange,a=e.geoJsonToRender,o=e.selectedWard,c=e.setSelectedWard,s=i.useState(6),l=Object(u.a)(s,2),f=l[0],d=l[1],p=function(e,t,n,r){var a=i.useState({}),o=Object(u.a)(a,2),c=o[0],s=o[1],l=i.useState(!1),f=Object(u.a)(l,2),d=f[0],p=f[1],m=i.useRef(),g=i.useRef();return i.useEffect(function(){return g.current=window.setTimeout(function(){window.clearInterval(m.current),d&&(s({}),p(!1))},r),function(){return window.clearTimeout(g.current)}},[d,r]),i.useEffect(function(){return p(!0),m.current=window.setTimeout(function(){p(!1),s({})},n),function(){return window.clearTimeout(m.current)}},[].concat(Object(R.a)(t),[n])),i.useEffect(function(){p(!1)},[c]),i.useCallback(e,[c])}(function(e){if(!e||!e.properties)return{};var a=e.properties,c=o&&a["Ward Code"]===o.properties["Ward Code"],u=(z(t,a)-n)/r;return{stroke:f>9,color:"rgba(0, 0, 0, ".concat(c?.8:.3,")"),weight:c?2:1,opacity:.6,fill:!0,fillOpacity:.5*Math.abs(.5-u)+.3,fillColor:"rgb(".concat(Math.max(0,Math.round(255-255*u)),", ").concat(Math.min(255,Math.round(255*u)),", 0)")}},[f,t,n,r,o],250,1e3),m=i.useCallback(function(e){d(e.target.getZoom())},[]),g=i.useCallback(function(e){c(e.layer.feature)},[]);return i.createElement(F.a,{zoom:f,center:[53,-1.75],onZoom:m},i.createElement(G.a,{attribution:'&copy <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),a?i.createElement(K.a,{data:a,style:p,onClick:g}):null)},_=n(119),Z=n(129),U=["WD11CD","WD11CDO","WD11NM","WD11NMW","Ward Code","Ward Name"],q=Object(S.a)(function(e){return Object(C.a)({drawer:{padding:e.spacing(2)}})}),H=function(e){var t=e.selectedWard,n=e.score,r=e.rank,a=e.total,o=e.setSelectedWard,c=Object(W.a)(),u=q(c),s=i.useCallback(function(e){return function(){o(e)}},[]),l=t?i.createElement("div",{className:u.drawer},i.createElement(_.a,{variant:"h2",component:"h1"},t.properties["Ward Name"]),i.createElement(_.a,null,t.properties["Ward Name"]),i.createElement(_.a,null,"Score: ",Math.round(1e4*n)/100,"%"),i.createElement(_.a,null,"Rank: ",r," of ",a),Object.keys(t.properties).map(function(e){return U.includes(e)||b.test(e)||k.test(e)?null:i.createElement(_.a,{key:e},e,": ",t.properties[e])})):null;return i.createElement(Z.a,{anchor:"right",open:!!t,onClose:s(null),onOpen:s(t)},l)},Y=n(121),$=n(135),Q=n(138),X=n(140),ee=n(128),te=n(133),ne=Object(S.a)(function(e){return Object(C.a)({fab:{position:"absolute",bottom:e.spacing(2),left:e.spacing(2)},drawer:{padding:e.spacing(2)},entry:{display:"flex",flexWrap:"nowrap",marginBottom:e.spacing(2)}})}),re=function(e){var t=e.weightings,n=e.setWeightings,a=Object(W.a)(),o=ne(a),c=i.useState(!1),s=Object(u.a)(c,2),l=s[0],f=s[1],d=i.useCallback(function(){f(!l)},[l]),p=i.useCallback(function(e){return function(r){n(Object(B.a)({},t,Object(T.a)({},e,{type:t[e].type,weight:parseFloat(r.currentTarget.value)})))}},[t]),m=i.useCallback(function(e){return function(r){n(Object(B.a)({},t,Object(T.a)({},e,{weight:t[e].weight,type:parseInt(r.currentTarget.value,10)})))}},[t]);return i.createElement(i.Fragment,null,i.createElement(Y.a,{"aria-label":"Edit weightings",className:o.fab,color:"primary",onClick:d},i.createElement(te.a,null)),i.createElement(Z.a,{open:l,onClose:d,onOpen:d},i.createElement("div",{className:o.drawer},Object.keys(t).map(function(e){var n=t[e],a=n.weight,c=n.type;return i.createElement("div",{className:o.entry,key:e},i.createElement($.a,{label:e,value:a||0,onChange:p(e)}),i.createElement(Q.a,null,i.createElement(X.a,null,"\xa0"),i.createElement(ee.a,{native:!0,onChange:m(e),value:c},i.createElement("option",{value:r.Value},"Value"),i.createElement("option",{value:r.Normalised},"Normalised"),i.createElement("option",{value:r.Rank},"Rank"))))}))))},ae=function(e){var t=e.sheetData,n=e.geoJsonData,r=e.weightings,a=e.selectedWard,o=e.setSelectedWard,c=e.setWeightings,s=i.useMemo(function(){return t&&n?t.map(function(e){var t=e["Ward Code"],r=n.get(t);return Object(B.a)({},r,{properties:Object(B.a)({},r.properties,e)})}):null},[t,n]),l=P(function(){if(!s)return{minScore:0,scoreRange:1e-6};var e=s.reduce(function(e,t){var n=e.minScore,a=e.maxScore,o=t.properties,c=z(r,o);return{minScore:Math.min(n,c),maxScore:Math.max(a,c)}},{minScore:1/0,maxScore:-1/0}),t=e.minScore;return{minScore:t,scoreRange:e.maxScore-t+1e-6}},[s,r],2e3,5e3),f=l.minScore,d=l.scoreRange,p=P(function(){return new Map(t.map(function(e){return[e["Ward Code"],(z(r,e)-f)/d]}).sort(function(e,t){var n=Object(u.a)(e,2),r=(n[0],n[1]),a=Object(u.a)(t,2);a[0];return a[1]-r}).map(function(e,t){var n=Object(u.a)(e,2);return[n[0],{score:n[1],rank:t+1}]}))},[r,t,f,d],2e3,5e3),m=i.useMemo(function(){return p.get(a?a.properties["Ward Code"]:"")||{score:0,rank:0}},[p,a]),g=m.score,h=m.rank;return i.createElement("div",{className:"data-container"},i.createElement(V,{weightings:r,selectedWard:a,minScore:f,scoreRange:d,geoJsonToRender:s,setSelectedWard:o}),i.createElement(H,{selectedWard:a,setSelectedWard:o,score:g,rank:h,total:t.length}),i.createElement(re,{weightings:r,setWeightings:c}))},oe="_os";function ce(e,t,n,r){return e.then(function(e){return e?new Promise(function(a){var o=e.transaction([e.name+oe],"readwrite").objectStore(e.name+oe).get(t);o.onerror=function(a){return console.error("Could not read key ".concat(t," from DB ").concat(e.name)),console.error(a),r(n(t))},o.onsuccess=function(){if(o.result)return a(r(Promise.resolve(o.result.value)));Promise.resolve(n(t)).then(function(n){return e.transaction([e.name+oe],"readwrite").objectStore(e.name+oe).add({id:t,value:n}).onerror=function(n){console.error("Could not write new key ".concat(t," to DB ").concat(e.name)),console.error(n)},a(r(Promise.resolve(n)))})}}):r(n(t))})}function ue(e){return ie.apply(this,arguments)}function ie(){return(ie=Object(c.a)(o.a.mark(function e(t){var n,r,a,c;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.sheetName,r=t.range,e.next=3,new Promise(function(e,t){return gapi.client.drive.files.list({q:"name='".concat(n,"'"),pageSize:1,fields:"nextPageToken, files(id, name)"}).then(function(t){return e(t.result.files[0]||null)},function(e){t(e)})});case 3:if(a=e.sent){e.next=6;break}throw new Error("Cannot find sheet.");case 6:return e.next=8,new Promise(function(e,t){return gapi.client.sheets.spreadsheets.values.get({spreadsheetId:a.id,range:r,majorDimension:"ROWS",valueRenderOption:"UNFORMATTED_VALUE"}).then(function(n){if(!n.result.values)return t("No value data returned.");e(n.result.values)},function(e){t(e)})});case 8:return c=e.sent,e.abrupt("return",c);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}function se(){return(se=Object(c.a)(o.a.mark(function e(t){var n,r,a;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.filename,e.next=3,new Promise(function(e,t){return gapi.client.drive.files.list({q:"name='".concat(n,"'"),pageSize:1,fields:"nextPageToken, files(id, name)"}).then(function(t){e(t.result.files[0]||null)},function(e){t(e)})});case 3:if(r=e.sent){e.next=6;break}throw new Error("Cannot find document.");case 6:return e.next=8,new Promise(function(e,t){return gapi.client.drive.files.get({fileId:r.id,alt:"media"}).then(function(t){return e(t.result)},function(e){t(e)})});case 8:return a=e.sent,e.abrupt("return",a);case 10:case"end":return e.stop()}},e)}))).apply(this,arguments)}function le(e){return fe.apply(this,arguments)}function fe(){return(fe=Object(c.a)(o.a.mark(function e(t){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.then(function(e){return A.loaded(new Map(e.features.map(function(e){return[e.properties.WD11CD,e]})))}).catch(function(e){return A.error(e)}));case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}n(84);var de="ward-stats",pe=Object(l.a)();var me=document.getElementById("root");Object(s.render)(i.createElement(function(){var e=function(e){var t=i.useState(A.loading()),n=Object(u.a)(t,2),r=n[0],a=n[1],o=i.useMemo(function(){var e=new FileReader;return e.onloadend=function(t){a(A.loaded(JSON.parse(e.result)))},e},[a]);return[{ref:e,onChange:i.useCallback(function(e){var t=e.target.files[0];o.readAsText(t)},[o])},r]}(i.useRef(null)),t=Object(u.a)(e,2),n=(t[0],t[1],i.useState(null)),a=Object(u.a)(n,2),s=a[0],l=a[1],w=i.useState(A.preload()),O=Object(u.a)(w,2),S=O[0],C=O[1],W=i.useState(A.preload()),N=Object(u.a)(W,2),x=N[0],R=N[1],I=i.useState(!1),M=Object(u.a)(I,1)[0],P=i.useMemo(function(){return e=de,"indexedDB"in window?new Promise(function(t){var n=window.indexedDB.open(e,2);n.onerror=function(n){console.error("Could not open DB ".concat(e)),console.error(n),t(null)},n.onsuccess=function(){console.info("Opened DB ".concat(e)),t(n.result)},n.onupgradeneeded=function(n){console.info("Setting up DB ".concat(e));var r=this.result,a=e+oe;r.createObjectStore(a,{keyPath:"id"}).transaction.oncomplete=function(){t(r)}}}):Promise.resolve(null);var e},[]),T=i.useCallback(Object(c.a)(o.a.mark(function e(){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(M){e.next=2;break}return e.abrupt("return",Promise.reject("Not signed in"));case 2:return e.next=4,ue({sheetName:j,range:E}).then(function(e){return J(L(e))});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e)})),[M]),B=i.useCallback(function(e){return e.then(function(e){return A.loaded(e)}).catch(function(e){return A.error(e)})},[]);i.useEffect(function(){M&&ce(P,"sheetData",T,B).then(function(e){C(e)})},[M,P,T]),i.useEffect(function(){var e=S.data();e&&!s&&l(Object.keys(e[0]).reduce(function(e,t){return v.includes(t)||b.test(t)||k.test(t)||(e[t]={weight:0,type:r.Normalised}),e},{}))},[S]);var z=i.useCallback(function(){return M?function(e){return se.apply(this,arguments)}({filename:y}):Promise.reject("Not signed in")},[M]);i.useEffect(function(){M&&ce(P,"geoJSON",z,le).then(function(e){R(e)})},[M,P,z]);var F=i.useState(null),G=Object(u.a)(F,2),K=G[0],V=G[1],_=S.data(),Z=x.data();return i.createElement(d.a,{theme:pe},i.createElement("div",{className:"App"},i.createElement(f.a,null,i.createElement(D,{apiKey:m,clientId:p,discoveryDocs:g,scope:h,signedInState:I}),_&&Z&&s?i.createElement(ae,{sheetData:_,geoJsonData:Z,weightings:s,selectedWard:K,setSelectedWard:V,setWeightings:l}):S.isLoading()||x.isLoading()?i.createElement("p",null,"Loading..."):i.createElement(i.Fragment,null,S.error()?i.createElement("p",null,S.error()):null,x.error()?i.createElement("p",null,x.error()):null))))},null),me)}},[[73,2,1]]]);
//# sourceMappingURL=main.09401fd2.chunk.js.map